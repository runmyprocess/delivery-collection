"use strict";!function(c){c.alert=alertify,c.backoffice={};var d=!(c.editor=""),o={key:null,lang:"en",collection:"col_item",widget_form:"id_form",widget_action:"id_action",widget_report:"id_report",modal:{width:200},editor:null,message:{en:{create:{title:"Create a new item",button:"Create",success:"The item was successfully created.",failure:"An error occurred while adding the item. Please contact your administrator."},read:{failure:"An error occurred while loading the item. Please contact your administrator."},update:{title:"Update an existing item",button:"Update",success:"The item was successfully updated.",failure:"An error occurred while updating the item. Please contact your administrator."},delete:{success:"The item was successfully deleted.",failure:"An error occurred while deleting the item. Please contact your administrator."},check:{exist:"This item already exists in the collection.",required:"Please fill in all the required fields.",failure:"An error occurred while checking if the item already exists. Please contact your administrator."},open:{failure:"An error occurred while opening the form. Please contact your administrator."},setup:{failure:"An error occurred while starting the back office. Please contact your administrator."}},fr:{create:{title:"Créer un nouvel élément",button:"Créer",success:"L'élément a été créé avec succès.",failure:"Une erreur s'est produite lors de l'ajout de l'élément. Veuillez contacter votre administrateur."},read:{failure:"Une erreur s'est produite lors du chargement de l'élément. Veuillez contacter votre administrateur."},update:{title:"Modifier un élément existant",button:"Modifier",success:"L'élément a été modifié avec succès.",failure:"Une erreur s'est produite lors de la modification de l'élément. Veuillez contacter votre administrateur."},delete:{success:"L'élément a été supprimé avec succès.",failure:"Une erreur s'est produite lors de la suppression de l'élément. Veuillez contacter votre administrateur."},check:{exist:"Cet élément existe déjà dans la collection.",required:"Veuillez renseigner tous les champs obligatoires.",failure:"Une erreur s'est produite lors du contrôle d'unicité de l'élément. Veuillez contacter votre administrateur."},open:{failure:"Une erreur s'est produite lors de l'ouverture du formulaire. Veuillez contacter votre administrateur."},setup:{failure:"Une erreur s'est produite lors du démarrage du back office. Veuillez contacter votre administrateur."}}},ckeditor:{language:"fr",toolbarGroups:[{name:"clipboard",groups:["clipboard","undo"]},{name:"document",groups:["mode"]},"/",{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent"]},{name:"links"}],width:600,format_tags:"p;h1;h2;h3"}},s={error:["font-weight: bold","color: #F00"].join(";"),standard:["font-weight: normal","color: #000"].join(";")};function l(e,t){if(!0===d&&(console.log("DEBUG: New Backoffice object instance created (Name: "+e+")"),console.log("DEBUG: ("+e+" back office) configuration:"),console.log(t)),!(this instanceof l))return console.log('You shall use the "new" keyword when calling the Backoffice constructor.'),new l(e,t);if(this.name="DELIVERY.backoffice."+e,t=_.merge(o,t),this.key=_.get(t,"key"),this.lang=_.get(t,"lang"),this.collection=_.get(t,"collection"),this.widget_form=_.get(t,"widget_form"),this.widget_action=_.get(t,"widget_action"),this.widget_report=_.get(t,"widget_report"),this.editor=_.get(t,"editor"),this.modal=_.get(t,"modal"),this.message=_.get(t,"message"),this.ckeditor=_.get(t,"ckeditor"),!r.call(this))return c.alert.error(this.message[this.lang].open.failure),!1;function i(){$('[id="'+this.widget_form+'"]').dialog("close")}function r(){!0===d&&console.log("DEBUG: Check Interface");var e=!0;if(window[this.widget_report]&&"RMP_Report"===window[this.widget_report].getType()||(console.log("%cERROR: %cYou shall create a Report Widget with the ID "+this.widget_report+" in your web interface.",s.error,s.standard),e=!1),window[this.collection]&&"RMP_IncludedCollection"===window[this.collection].getType()||(console.log("%cERROR: %cYou shall include a Collection with the ID "+this.collection+" in your web interface.",s.error,s.standard),e=!1),window[this.widget_form]&&"RMP_Table"===window[this.widget_form].getType()||(console.log("%cERROR: %cYou shall create a Split Widget with the ID "+this.widget_form+" in your web interface.",s.error,s.standard),e=!1),window[this.widget_action]||(console.log("%cERROR: %cYou shall create an empty HTML Widget with the ID "+this.widget_action+" within the "+this.widget_form+" Split Widget.",s.error,s.standard),e=!1),this.editor){CKEDITOR||(console.log("%cERROR: %cYou shall integrate the ckeditor.js file in order to use the HTML wysiwyg editor.",s.error,s.standard),e=!1),Array.isArray(this.editor)||(console.log("%cERROR: %cThe editor parameter shall be an array of Widgets IDs.",s.error,s.standard),e=!1);for(var t=0;t<this.editor.length;t++)window[this.editor[t]]&&"RMP_TextInput"===window[this.editor[t]].getType()||(console.log("%cERROR: %cYou shall create a Text Widget with the ID "+this.editor[t]+" within the "+this.widget_form+" Split Widget in order to use the HTML wysiwyg editor.",s.error,s.standard),e=!1)}return e}function a(){!0===d&&console.log("DEBUG: Get Form Data");var i=this.widget_form,r=this.editor,a={},o=[],s="",l="",n="";return RMPApplication.forEachWidget(function(e){var t=e.getParent();if(t&&_.has(t,"conf.id")&&t.conf.id===i)switch(e.getType()){case"RMP_ListBox":o=JSON.parse(e.getListOfMyVariables()),l=o[0].split(".")[1],s=o[1].split(".")[1],n=o[1].split(".")[0],_.set(a,n+"."+l,e.getSelectedLabel()),_.set(a,n+"."+s,e.getSelectedValue());break;case"RMP_RadioButton":o=JSON.parse(e.getListOfMyVariables()),l=o[0],s=o[1],_.set(a,l,e.getSelectedLabel()),_.set(a,s,e.getSelectedValue());break;case"RMP_MultiSelectionListBox":case"RMP_MultiSelectionCheckBox":o=JSON.parse(e.getListOfMyVariables()),l=o[0].split(".")[1],s=o[1].split(".")[1],n=o[1].split(".")[0],_.set(a,n+"."+l,JSON.parse(e.getSelectedLabel())),_.set(a,n+"."+s,JSON.parse(e.getSelectedValue()));break;case"RMP_TextInput":o=JSON.parse(e.getListOfMyVariables()),s=o[0],r&&-1!==r.indexOf(e.getName())?a[s]=c.editor.getData()||"":_.set(a,s,e.getValue());break;case"RMP_Html":break;default:console.log("Unmanaged widget type: "+e.getType())}}),a}this.editItem=function(e,t){if(!0===d&&console.log("DEBUG: ("+this.name+") Edit Item"),!e||!_.isString(e)||!_.includes(["create","update"],e))return c.alert.error(this.message[this.lang].setup.failure),console.log("%cERROR: %cUnrecognized 'action' parameter passed to the editItem function. Should be 'create' or 'update'.",s.error,s.standard),!1;if(!("update"!==e||t&&_.isString(t)&&0!==_.size(t)))return c.alert.error(this.message[this.lang].setup.failure),console.log("%cERROR: %cMissing 'uid' parameter for the editItem function used with the 'update' action.",s.error,s.standard),!1;var i=_.template('<hr><button class="gwt-Button" onclick="<%= button_action %>"><%= button_label %></button>'),r="";switch(e){case"create":!0===d&&console.log("DEBUG: ("+this.name+") Edit Item --\x3e Create"),function(){!0===d&&console.log("DEBUG: Reset Form Data");var i=this.widget_form;RMPApplication.forEachWidget(function(e){var t=e.getParent();if(t&&_.has(t.conf,"id")&&t.conf.id===i)switch(e.getType()){case"RMP_ListBox":case"RMP_MultiSelectionListBox":case"RMP_MultiSelectionCheckBox":case"RMP_RadioButton":e.reset();break;case"RMP_TextInput":e.setValue(e.getDefaultValue());break;case"RMP_Html":break;default:console.log("Unmanaged widget type: "+e.getType())}})}.call(this),r=i({button_action:this.name+".createItem()",button_label:this.message[this.lang].create.button}),window[this.widget_action].setHtml(r),window[this.widget_form].setVisible(!0),this.openModal("create");break;case"update":!0===d&&console.log("DEBUG: ("+this.name+") Edit Item --\x3e Update"),r=i({button_action:this.name+".updateItem('"+t+"')",button_label:this.message[this.lang].update.button}),window[this.widget_action].setHtml(r),window[this.widget_form].setVisible(!0),this.readItem(t);break;default:return console.log("%cERROR: %cThe action parameter passed to the DELIVERY.collection.editItem function isn't recognized",s.error,s.standard),!1}},this.createItem=function(){if(!0===d&&console.log("DEBUG: ("+this.name+") Create Item"),!r.call(this))return c.alert.error(this.message[this.lang].create.failure),!1;if(!RMPApplication.validate())return c.alert.error(this.message[this.lang].check.required),!1;if(!0===function(){!0===d&&console.log("DEBUG: Check Item");if(!this.key)return!1;var e=this.key.reduce(function(e,t){return e[t]=RMPApplication.getVariable(t),e},{}),t=!1;return window[this.collection].listCallback(e,{asynchronous:false},function(e){t=!!e[0]},function(e){c.alert.error(this.message[this.lang].check.failure),console.log(e)}),t}.call(this))return c.alert.error(this.message[this.lang].check.exist),!1;var t=this;window[this.collection].saveCallback(_.merge(a.call(this),{uid:RMPApplication.uuid()}),function(){c.alert.success(t.message[t.lang].create.success),window[t.widget_report].refresh(),i.call(t)},function(e){c.alert.error(t.message[t.lang].create.failure),console.log(e)})},this.readItem=function(e){if(!0===d&&console.log("DEBUG: ("+this.name+") Read Item"),!r.call(this))return c.alert.error(this.message[this.lang].read.failure),!1;if(!e||"undefined"===e)return c.alert.error(this.message[this.lang].read.failure),console.log("%cERROR: %cAn UID parameter shall be passed to the DELIVERY.collection.readItem function",s.error,s.standard),!1;var l=this.widget_form,t=this;var i={uid:e};window[this.collection].listCallback(i,{},function(e){var i=_.nth(e,0),r=[],a="",o="",s="";return RMPApplication.forEachWidget(function(e){var t=e.getParent();if(t&&_.has(t,"conf.id")&&t.conf.id===l)switch(e.getType()){case"RMP_RadioButton":r=JSON.parse(e.getListOfMyVariables()),a=r[1],_.has(i,a)?e.setSelectedValue(_.get(i,a)):e.reset();break;case"RMP_MultiSelectionListBox":case"RMP_MultiSelectionCheckBox":case"RMP_ListBox":s=JSON.parse(e.getListOfMyVariables())[1].split(".")[0],o=JSON.parse(e.getListOfMyVariables())[0].split(".")[1],a=JSON.parse(e.getListOfMyVariables())[1].split(".")[1],"RMP_MultiSelectionListBox"===e.getType()||"RMP_MultiSelectionCheckBox"===e.getType()?_.has(i,s)?e.setPicked(JSON.stringify(i[s][o]),JSON.stringify(i[s][a])):e.reset():_.has(i,s)?e.setSelectedValue(i[s][a]):e.reset();break;case"RMP_TextInput":r=JSON.parse(e.getListOfMyVariables()),a=r[0],e.setValue(_.get(i,a,""));break;case"RMP_Html":break;default:console.log("Unmanaged widget type: "+e.getType())}}),t.openModal("update"),!0},function(e){return c.alert.error(this.message[this.lang].read.failure),window[this.widget_report].refresh(),console.log(e),!1})},this.updateItem=function(e){if(!0===d&&console.log("DEBUG: ("+this.name+") Update Item"),!r.call(this))return c.alert.error(this.message[this.lang].update.failure),!1;if(!e||!_.isString(e)||"undefined"===e)return c.alert.error(this.message[this.lang].update.failure),console.log("%cERROR: %cAn UID parameter shall be passed to the DELIVERY.collection.updateItem function",s.error,s.standard),!1;if(!RMPApplication.validate())return c.alert.error(this.message[this.lang].check.required),!1;var t=this;window[this.collection].updateCallback({uid:e},_.merge(a.call(this),{uid:e}),function(){c.alert.success(t.message[t.lang].update.success),window[t.widget_report].refresh(),i.call(t)},function(e){c.alert.error(t.message[t.lang].update.failure),console.log(e)})},this.deleteItem=function(e){if(!0===d&&console.log("DEBUG: ("+this.name+") Delete Item"),!r.call(this))return c.alert.error(this.message[this.lang].delete.failure),!1;if(!e||"undefined"===e)return c.alert.error(this.message[this.lang].delete.failure),console.log("%cERROR: %cAn UID parameter shall be passed to the DELIVERY.collection.deleteItem function",s.error,s.standard),!1;var t=this;window[this.collection].removeCallback({uid:e},function(){c.alert.success(t.message[t.lang].delete.success),window[t.widget_report].refresh()},function(e){return c.alert.error(t.message[t.lang].delete.failure),console.log(e),!1})},this.setReportActions=function(e,t){if(!_||"string"!=typeof _.VERSION)return!1;var i=_.template('<a href="#" class="<%= link_class %>" onClick="<%= link_action %>"></a>'),r=i({link_class:"update",link_action:this.name+".editItem('update', '"+e+"')"}),a=i({link_class:"delete",link_action:this.name+".deleteItem('"+e+"')"});return t&&_.isString(t)&&_.includes(["update","delete"],t)?"update"===t?r:"delete"===t?a:void 0:r+a},this.openModal=function(e){!0===d&&console.log("DEBUG: ("+this.name+") Open Modal");var t=$('[id="'+this.widget_form+'"]').dialog({autoOpen:!1,modal:!0,stack:!1,width:this.modal.width,title:this.message[this.lang][e].title,open:function(e,t){if(this.editor){c.editor=CKEDITOR.replace(this.editor[0],this.ckeditor);var i=window[this.editor[0]].getValue()||"";c.editor.setData(i)}},close:function(e,t){this.editor&&c.editor.destroy()}});$(t).dialog("open")}}c.backoffice.create=function(e,t){return"undefined"==typeof _||"string"!=typeof _.VERSION?(c.alert.error(o.message[o.lang].setup.failure),console.log("%cERROR: %cYou shall add the Lodash library (https://lodash.com/) to the web interface's JavaScript files.",s.error,s.standard),!1):e&&_.isString(e)&&0!==_.size(_.trim(e))?t&&!_.isPlainObject(t)?(c.alert.error(o.message[o.lang].setup.failure),console.log("%cERROR: %cThe configuration passed as the second parameter of the DELIVERY.backoffice.create function shall be a plain object.",s.error,s.standard),!1):(e=_.replace(_.trim(e)," ","_"),void(c.backoffice[e]=new l(e,t))):(c.alert.error(o.message[o.lang].setup.failure),console.log("%cERROR: %cYou shall define an instance name (string) as the first parameter of the DELIVERY.backoffice.create function.",s.error,s.standard),!1)}}(window.DELIVERY=window.DELIVERY||{});